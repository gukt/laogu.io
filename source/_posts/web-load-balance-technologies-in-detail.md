title: 常见的Web负载均衡技术详解
s: web-load-balance-technologies-in-detail
date: 2015-09-25 23:51:01
tags:
---
### 1. 基于镜像站点的负载均衡

最早的负载均衡技术可以追溯到古老的镜像站点技术，其本质是制作多个站点的拷贝（镜像），然后在网页上提供站点列表，供用户选择，从而达到分流负载的目的。该技术现在仍然被一些如下载站点使用。
 
#### 优缺点
该方案最大的特点就是简单；服务端不需要特别的技术支持，只要克隆多个站点即可，制作镜像本质上是文件的同步，因为它更加适合用在静态网站上。
 
### 2. 基于HTTP重定向的负载均衡

#### 什么是HTTP重定向
> HTTP重定向是HTTP代理（如浏览器）与Web服务器共同实现的。服务器通过返回302状态码，以及在HTTP响应的Header中添加Location=url，HTTP代理收到该重定向响应后重新请求location指示的地址，这样就完成了一次HTTP重定向

HTTP重定向的机制可以用来做负载均衡，具体的调度算法由服务器实现，可以根据地域就近原则，或简单的轮询（Round Robin）或其他调度算法，从而达到将负载分发到多个后端服务器的目的。

HTTP重定向类似于“镜像站点负载均衡”，其最大的不同是：镜像站点是让用户选择的，而HTTP重定向的路由调度是由Web服务端的代码逻辑实现的。
 
#### 优点

*	实现简单，由一小段代码即可实现完成简单的调度分发
*	调度灵活自由，因为调度算法是自己实现的
    
#### 存在的问题

*	伸缩性不好，集群中增减主机往往需要修改代码（或服务器列表配置文件），这可能会导致重新部署（虽然这也可以通过代码来解决）
*	如果重定向后的页面被客户端收藏，此后的请求就一直由那台机器提供服务，这将导致之前制定的负载分发策略失效，也不能实现“故障转移”。
*	集群的最大吞吐量受到负载均衡器性能的制约
*	对搜索引擎不友好，搜索引擎对HTTP重定向经常判定为作弊
*	请求需要两个往返才可以完成，因此效率不高。

### 3. 基于DNS轮询的负载均衡

DNS服务器可以针对某个域名添加多个A纪录，比如A1，A2，A3，当客户端每次访问DNS服务器让其解析域名对应的IP地址时，DNS服务器会依次从事先添加的A记录中返回，从而达到负载依次被分发到A1，A2，A3地址所对应的服务器进行处理，该策略最大的优点也是简单，但它同样也存在一些问题。

#### 存在的问题
*	**浪费公网IP地址**
每个A记录对应的IP地址都是要事先准备好的，而且必须是外网地址，我们知道，在互联网上，IPv4地址已经相当紧张

*	**并不一定能实现预期的均等**
因为HTTP代理（比如浏览器或各种代理服务器）会缓存DNS的解析结果，在DNS缓存没有失效之前，客户端都不会再请求DNS服务器。

*	**不能感知Web服务器的健康状况**
DNS服务器只是机械地轮流解析，它才不管某台机器负载已经很重，甚至某台机器已经挂掉了，它仍然会将负载分流到这些已经坏了的机器，导致无法提供服务的情况。

*	**难以实现故障转移**
如果发现之前添加到DNS服务器中的某台机器发生了故障，这个时候最理想的期望是立即从DNS服务器的A纪录中拿掉这台发生故障的主机记录，但是这往往很难实现，这是因为：

1. 由于客户端DNS解析缓存的存在，在TTL没有过期之前，客户端仍然会一直请求故障机

2. 鉴于上门所说的，DNS不能及时感知Web服务器的健康状况，一旦机器故障，我们能做的只是人工去修改DNS映射，但是这种更新往往又不能立即生效，因此会造成较长时间的不能提供服务。

*	**灵活性不够**
基于DNS的负载分发工作在DNS层面，而像HTTP重定向是基于HTTP应用层的，因此对于前者来说，如果需要提供更多的调度策略往往比较难，而对于后者，可以基于更多的场景来实现更丰富的调度逻辑，比如：基于地域，基于IP，基于不同的URL模式等。

实际上，该方案可用于小型网站的负载分发，而在大型网站往往只是部分采用，大型网站往往采用“层级负载均衡方案”，即先配置使用DNS轮询，完成域名对多个IP的解析，添加的A记录对应于多个对外服务的负载均衡器，请求达到每个负载均衡器后，再由负载均衡器对请求进行再调度。

### 4. 基于IP的负载均衡
IP负载均技术是工作在四层（网络层）的使用最广的负载均衡技术，它是在操作系统的内核进程中对请求进行转发的，因此相比其他负载均衡技术（如反向代理负载均衡）它的效率更高。

该技术提供三种模式：

#### VS/NAT（网络地址转换）

##### 处理流程

*	负载均衡器收到来自客户端的请求报文
*	通过调度算法得到一台真实服务器
*	修改请求报文中的“目标IP地址”和“目标端口”为刚刚得到的真实机器的IP和端口
*	将该请求报文转发给真实服务器去处理
*	真实服务器处理完后，将响应报文发给负载均衡器
*	负载均衡器将响应报文中的“源IP地址”和“源端口”再次改为VIP（提供对外服务的虚拟IP）
*	将响应报文发回客户端

##### 优缺点
*	负载均衡器需要对请求报文修改一次，然后还要对响应报文再一次修改
*	响应报文必须再次经过负载均衡器，因此负载均衡器负担加重
*	响应报文往往比请求报文大很多，如果响应报文如果也经过负载均衡器，那么负载均衡器的网卡带宽将会是一个瓶颈

#### VS/DR（直接服务器路由）

VS/DR是使用最广的一种模式，它的处理流程比VS/NAT简单高效

##### 处理流程

*	负载均衡器收到客户端请求
*	通过调度算法得到一台真实服务器
*	负载均衡器**对请求不做任何修改**，将其直接转发给真实服务器
*	真实服务器处理完成后**不用将响应报文发回到负载均衡器**，而是直接发回客户端

##### 优点
*	调度效率高，负载均衡器不用修改请求报文
*	响应报文不用发回负载均衡器，因此大大提高了负载均衡器的吞吐率
*	集群吞吐率只取决于负载军器的入口带宽以及集群的出口带宽

#### VS/TUN（IP隧道）
该模式应用的不多，所以不做详细介绍，具体请参加[这里](http://www.linuxvirtualserver.org/zh/lvs3.html#4)
 
> 最常用的是VS/DR模式，它最高效而且配置简单，关于"IP负载均衡技术"的详细介绍，请参考[官方文档](http://www.linuxvirtualserver.org/zh/index.html)

### 5. 基于反向代理的负载均衡

反向代理服务器是挡在真实服务器前面的服务器，用以隐藏后端的真实服务器，缓存部分请求内容，当然了，也可以作为负载均衡器使用

它的核心工作是转发HTTP请求（区别于HTTP重定向是‘转移’而非’转发'）。反向代理服务器可以配置各种灵活的规则实现对请求的转移。

#### 优点

*	有些反向代理服务器可以监控后端服务器组的多方面状态，这使得我们能够更加精细化的控制负载调度。
	> 比如Varnish，使用它作为负载均衡器，可以监控后端服务器的很多方面，比如:系统负载，响应时间，是否可用，TCP连接，流量等性能参数。

*	它工作在应用层的，因此相比于IP负载均衡技术而言，它可以提供更加完善的基于HTTP内容的调度策略，比如：
	*	根据IP地址进行黑白名单过滤
	*	可以实现地址重定向（如：/foo/bar指向到foo?id=bar）
	*	根据HTTP头中的User-Agent对搜索引擎爬虫的访问进行控制

#### 存在的问题

*	和基于IP负载均衡技术相比，效率不高
*	所有HTTP请求都要经过反向代理服务器，因此它容易成为集群新的瓶颈，当成为瓶颈后，增加再多的分流节点也无济于事。

> #### 声明：转载请注明出处
